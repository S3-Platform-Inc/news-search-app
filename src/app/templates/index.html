<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Поиск новостей</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Filter Sidebar -->
            <div class="col-md-3 bg-light p-4">
                <h4>Фильтры</h4>
                <form method="get" action="/">

                    <!-- Category select
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select">
                            <option value="">All</option>
                            {% for cat in categories %}
                                <option value="{{ cat }}" {% if request.query_params.get('category') == cat %}selected{% endif %}>{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    -->

                    <div class="mb-3">
                        <label class="form-label">Источник</label>
                        <select name="source" class="form-select">
                            <option value="">Все</option>
                            {% for src in sources %}
                                <option value="{{ src }}" {% if request.query_params.get('source') == src %}selected{% endif %}>{{ src }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Поиск</label>
                        <input type="text" name="search" class="form-control" value="{{ request.query_params.get('search', '') }}">
                    </div>

                    <!-- Keyword Filters -->
                    <h5 class="mt-4">Списки ключевых слов</h5>

                    {% for cat in keyword_categories %}
                        <div class="mb-3">
                            <label for="{{ cat }}_min" class="form-label">{{ cat }}</label>
                            <input
                                type="number"
                                id="{{ cat }}_min"
                                name="{{ cat }}_min"
                                class="form-control"
                                min="0"
                                placeholder="Min matches"
                                value="{{ request.query_params.get(cat ~ '_min', '0') }}"
                            >
                            <small class="text-muted">Требуемое минимальное число совпадений</small>
                        </div>
                    {% endfor %}



                    <button type="submit" class="btn btn-primary w-100">Применить фильтр</button>
                </form>
            </div>

            <!-- News Feed -->
            <div class="col-md-9 p-4">
                <h2>Новости</h2>
                <div class="row">
                    {% for news in news_items %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 {% if news.seen %}border-success{% endif %}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <!-- <span class="badge bg-secondary">{{ news.category }}</span> -->
                                        <small class="text-muted">{{ news.source }}</small>
                                    </div>
                                    <h5 class="card-title">{{ news.title }}</h5>
                                    <p class="card-text">{{ news.abstract }}</p>
                                    <a class="card-link" href={{news.link}} target="_blank" rel="noopener noreferrer">Ссылка</a>
                                    <div class="mt-2">
                                        {% set has_matches = false %}
                                        {% for category, matches in news.keyword_matches.items() %}
                                            {% if matches %}
                                                <span class="badge bg-info me-1">
                                                    {{ category }}: {{ matches|length }}
                                                </span>
                                                {% set has_matches = true %}
                                            {% endif %}
                                        {% endfor %}
                                        <!--
                                        {% if not has_matches %}
                                            <small class="text-muted">No keyword matches</small>
                                        {% endif %}
                                        -->
                                    </div>
                                    <!-- Mark as Seen Button -->
                                    {% if not news.seen %}
                                        <form onsubmit="markSeen(event, {{ news.id }})" class="mt-3">
                                            <button type="submit" class="btn btn-sm btn-outline-primary">Прочитать</button>
                                        </form>
                                    {% else %}
                                        <small class="text-success mt-2 d-block">✓ Прочитано</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
<script>
    function markSeen(event, newsId) {
        event.preventDefault();
        fetch(`/mark-seen/${newsId}`, { method: 'POST' })
            .then(() => {
                // Optionally update UI dynamically here
                location.reload();  // Or do partial refresh
            });
    }
</script>
</body>
</html>